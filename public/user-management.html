<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - 1.FC Köln Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem 2rem;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .club-logo {
            height: 48px;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1a1a1a;
        }

        .back-btn {
            padding: 0.625rem 1.25rem;
            background: white;
            border: 2px solid #e5e7eb;
            color: #333;
            text-decoration: none;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-block;
        }

        .back-btn:hover {
            border-color: #dc143c;
            color: #dc143c;
        }

        /* Action Bar */
        .action-bar {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-box {
            flex: 1;
            max-width: 400px;
        }

        .search-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #dc143c;
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
        }

        .add-btn {
            padding: 0.875rem 1.5rem;
            background: #dc143c;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .add-btn:hover {
            background: #b91c3c;
            transform: translateY(-2px);
        }

        /* Users Table */
        .table-container {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table thead {
            background: #f8f9fa;
        }

        .users-table th,
        .users-table td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .users-table th {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .users-table td {
            color: #1f2937;
        }

        .users-table tbody tr:hover {
            background: #f8f9fa;
        }

        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .role-badge.player {
            background: #dbeafe;
            color: #1e40af;
        }

        .role-badge.staff {
            background: #fef3c7;
            color: #92400e;
        }

        .role-badge.admin {
            background: #fee2e2;
            color: #991b1b;
        }

        .actions-cell {
            display: flex;
            gap: 0.5rem;
        }

        .btn-edit, .btn-delete {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-edit {
            background: #3b82f6;
            color: white;
        }

        .btn-edit:hover {
            background: #2563eb;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a1a1a;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            line-height: 1;
        }

        .close-btn:hover {
            color: #1f2937;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-field {
            display: flex;
            flex-direction: column;
        }

        .form-field.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-input, .form-select {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #dc143c;
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn-cancel {
            padding: 0.75rem 1.5rem;
            background: white;
            border: 2px solid #e5e7eb;
            color: #333;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancel:hover {
            border-color: #6b7280;
        }

        .btn-submit {
            padding: 0.75rem 1.5rem;
            background: #dc143c;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-submit:hover {
            background: #b91c3c;
        }

        /* Message */
        .message {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
            display: none;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
            display: block;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .users-table {
                font-size: 0.875rem;
            }

            .users-table th,
            .users-table td {
                padding: 0.75rem 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <img src="/logo.png" alt="1.FC Köln" class="club-logo">
                <h1 class="page-title">User Management</h1>
            </div>
            <a href="/dashboard.html" class="back-btn" data-testid="link-back-dashboard">← Back to Dashboard</a>
        </div>

        <!-- Message Area -->
        <div id="messageArea"></div>

        <!-- Action Bar -->
        <div class="action-bar">
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="Search users..." data-testid="input-search">
            </div>
            <button class="add-btn" onclick="openAddModal()" data-testid="button-add-user">+ Add User</button>
        </div>

        <!-- Users Table -->
        <div class="table-container">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>House</th>
                        <th>Position</th>
                        <th>Jersey #</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="7" class="empty-state">
                            <h3>Loading users...</h3>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add User</h2>
                <button class="close-btn" onclick="closeModal()" data-testid="button-close-modal">&times;</button>
            </div>

            <form id="userForm">
                <div class="form-grid">
                    <div class="form-field">
                        <label class="form-label">First Name *</label>
                        <input type="text" id="firstName" class="form-input" required data-testid="input-first-name">
                    </div>

                    <div class="form-field">
                        <label class="form-label">Last Name *</label>
                        <input type="text" id="lastName" class="form-input" required data-testid="input-last-name">
                    </div>

                    <div class="form-field full-width">
                        <label class="form-label">Email *</label>
                        <input type="email" id="email" class="form-input" required data-testid="input-email">
                    </div>

                    <div class="form-field">
                        <label class="form-label">Password <span id="passwordHint">*</span></label>
                        <input type="password" id="password" class="form-input" data-testid="input-password">
                    </div>

                    <div class="form-field">
                        <label class="form-label">Role *</label>
                        <select id="role" class="form-select" required data-testid="select-role">
                            <option value="">Select role...</option>
                            <option value="player">Player</option>
                            <option value="staff">Staff</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label class="form-label">House</label>
                        <select id="house" class="form-select" data-testid="select-house">
                            <option value="">Select house...</option>
                            <option value="Widdersdorf 1">Widdersdorf 1</option>
                            <option value="Widdersdorf 2">Widdersdorf 2</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label class="form-label">Position</label>
                        <select id="position" class="form-select" data-testid="select-position">
                            <option value="">Select position...</option>
                            <option value="Goalkeeper">Goalkeeper</option>
                            <option value="Defender">Defender</option>
                            <option value="Midfielder">Midfielder</option>
                            <option value="Forward">Forward</option>
                        </select>
                    </div>

                    <div class="form-field">
                        <label class="form-label">Jersey Number</label>
                        <input type="number" id="jerseyNumber" class="form-input" min="1" max="99" data-testid="input-jersey">
                    </div>

                    <div class="form-field">
                        <label class="form-label">Date of Birth</label>
                        <input type="date" id="dateOfBirth" class="form-input" data-testid="input-dob">
                    </div>

                    <div class="form-field">
                        <label class="form-label">Nationality</label>
                        <input type="text" id="nationality" class="form-input" data-testid="input-nationality">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal()" data-testid="button-cancel">Cancel</button>
                    <button type="submit" class="btn-submit" data-testid="button-save-user">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api/fckoln';
        let allUsers = [];
        let isEditing = false;
        let editingUserId = null;

        function getAuthHeaders() {
            const token = sessionStorage.getItem('fckoln_token');
            return {
                'Content-Type': 'application/json',
                'X-App-Key': 'fckoln_b3aae37289943ee96b595915fe9e425a643fa794cfd7ad81b8ed777a6928a505',
                'Authorization': `Bearer ${token}`
            };
        }

        // Check auth and staff/admin role
        function checkAuth() {
            const token = sessionStorage.getItem('fckoln_token');
            const user = sessionStorage.getItem('fckoln_user');

            if (!token || !user) {
                window.location.href = '/';
                return false;
            }

            try {
                const userData = JSON.parse(user);
                const role = userData.role.toLowerCase();
                if (role !== 'admin' && role !== 'staff') {
                    alert('Access denied. Staff or Admin only.');
                    window.location.href = '/dashboard.html';
                    return false;
                }
            } catch (error) {
                console.error('Failed to parse user data:', error);
                window.location.href = '/';
                return false;
            }

            return true;
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    headers: getAuthHeaders()
                });

                const data = await response.json();
                if (data.success) {
                    allUsers = data.users;
                    renderUsers(allUsers);
                } else {
                    showMessage(data.message || 'Failed to load users', 'error');
                }
            } catch (error) {
                console.error('Failed to load users:', error);
                showMessage('Failed to load users', 'error');
            }
        }

        // Render users
        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <h3>No users found</h3>
                            <p>Add your first user to get started</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr data-testid="row-user-${user.id}">
                    <td>${user.firstName} ${user.lastName}</td>
                    <td>${user.email}</td>
                    <td><span class="role-badge ${user.role}">${user.role}</span></td>
                    <td>${user.house || '-'}</td>
                    <td>${user.position || '-'}</td>
                    <td>${user.jerseyNumber || '-'}</td>
                    <td>
                        <div class="actions-cell">
                            <button class="btn-edit" onclick="editUser('${user.id}')" data-testid="button-edit-${user.id}">Edit</button>
                            <button class="btn-delete" onclick="deleteUser('${user.id}')" data-testid="button-delete-${user.id}">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Search users
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allUsers.filter(user => 
                `${user.firstName} ${user.lastName}`.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm) ||
                (user.role && user.role.toLowerCase().includes(searchTerm))
            );
            renderUsers(filtered);
        });

        // Open add modal
        function openAddModal() {
            isEditing = false;
            editingUserId = null;
            document.getElementById('modalTitle').textContent = 'Add User';
            document.getElementById('passwordHint').textContent = '*';
            document.getElementById('password').required = true;
            document.getElementById('userForm').reset();
            document.getElementById('userModal').classList.add('active');
        }

        // Edit user
        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            isEditing = true;
            editingUserId = userId;
            document.getElementById('modalTitle').textContent = 'Edit User';
            document.getElementById('passwordHint').textContent = '(leave blank to keep current)';
            document.getElementById('password').required = false;

            // Populate form
            document.getElementById('firstName').value = user.firstName || '';
            document.getElementById('lastName').value = user.lastName || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('role').value = user.role || '';
            document.getElementById('house').value = user.house || '';
            document.getElementById('position').value = user.position || '';
            document.getElementById('jerseyNumber').value = user.jerseyNumber || '';
            document.getElementById('dateOfBirth').value = user.dateOfBirth || '';
            document.getElementById('nationality').value = user.nationality || '';
            document.getElementById('password').value = '';

            document.getElementById('userModal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('userModal').classList.remove('active');
            document.getElementById('userForm').reset();
        }

        // Submit form
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const userData = {
                email: document.getElementById('email').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                role: document.getElementById('role').value,
                house: document.getElementById('house').value || null,
                position: document.getElementById('position').value || null,
                jerseyNumber: document.getElementById('jerseyNumber').value || null,
                dateOfBirth: document.getElementById('dateOfBirth').value || null,
                nationality: document.getElementById('nationality').value || null
            };

            const password = document.getElementById('password').value;
            if (password) {
                userData.password = password;
            }

            try {
                let url, method;
                if (isEditing) {
                    url = `${API_BASE}/admin/users/${editingUserId}`;
                    method = 'PUT';
                } else {
                    url = `${API_BASE}/admin/users`;
                    method = 'POST';
                }

                const response = await fetch(url, {
                    method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(userData)
                });

                const data = await response.json();
                if (data.success) {
                    showMessage(data.message || 'User saved successfully', 'success');
                    closeModal();
                    loadUsers();
                } else {
                    showMessage(data.message || 'Failed to save user', 'error');
                }
            } catch (error) {
                console.error('Failed to save user:', error);
                showMessage('Failed to save user', 'error');
            }
        });

        // Delete user
        async function deleteUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            if (!confirm(`Are you sure you want to delete ${user.firstName} ${user.lastName}?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                const data = await response.json();
                if (data.success) {
                    showMessage(data.message || 'User deleted successfully', 'success');
                    loadUsers();
                } else {
                    showMessage(data.message || 'Failed to delete user', 'error');
                }
            } catch (error) {
                console.error('Failed to delete user:', error);
                showMessage('Failed to delete user', 'error');
            }
        }

        // Show message
        function showMessage(text, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        // Initialize
        if (checkAuth()) {
            loadUsers();
        }
    </script>
</body>
</html>
