<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Management - 1.FC K√∂ln Talent Program</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem 2rem;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .club-logo {
            height: 48px;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1a1a1a;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .back-btn, .create-btn {
            padding: 0.625rem 1.25rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            cursor: pointer;
        }

        .back-btn {
            background: white;
            color: #333;
        }

        .create-btn {
            background: #dc143c;
            border-color: #dc143c;
            color: white;
        }

        .back-btn:hover {
            border-color: #dc143c;
            color: #dc143c;
        }

        .create-btn:hover {
            background: #b81133;
            border-color: #b81133;
        }

        /* Calendar */
        .calendar-container {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .calendar-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-btn {
            padding: 0.5rem 1rem;
            background: white;
            border: 2px solid #e5e7eb;
            color: #333;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            border-color: #dc143c;
            color: #dc143c;
        }

        .current-month {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a1a1a;
        }

        /* Events List */
        .events-list {
            display: grid;
            gap: 1rem;
        }

        .event-card {
            padding: 1.5rem;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            transition: all 0.2s;
        }

        .event-card.training {
            border-left: 4px solid #3b82f6;
        }

        .event-card.match {
            border-left: 4px solid #dc143c;
        }

        .event-card.meeting {
            border-left: 4px solid #8b5cf6;
        }

        .event-card.other {
            border-left: 4px solid #10b981;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .event-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1a1a1a;
        }

        .event-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .event-type-badge.training {
            background: #dbeafe;
            color: #1e40af;
        }

        .event-type-badge.match {
            background: #fee2e2;
            color: #991b1b;
        }

        .event-type-badge.meeting {
            background: #ede9fe;
            color: #5b21b6;
        }

        .event-type-badge.other {
            background: #d1fae5;
            color: #065f46;
        }

        .event-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .event-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            font-size: 0.875rem;
        }

        .event-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            color: #333;
        }

        .action-btn.edit {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .action-btn.delete {
            border-color: #ef4444;
            color: #ef4444;
        }

        .action-btn.attendance {
            border-color: #10b981;
            color: #10b981;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a1a1a;
        }

        .close-btn {
            font-size: 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #dc143c;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .submit-btn {
            width: 100%;
            padding: 0.75rem;
            background: #dc143c;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submit-btn:hover {
            background: #b81133;
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Checkbox styles */
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .form-hint {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: #666;
        }

        /* Message */
        .message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        /* Attendance List */
        .attendance-list {
            margin-top: 1rem;
        }

        .attendance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .attendance-name {
            font-weight: 600;
            color: #333;
        }

        .attendance-status {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .attendance-status.attending {
            background: #d1fae5;
            color: #065f46;
        }

        .attendance-status.not_attending {
            background: #fee2e2;
            color: #991b1b;
        }

        .attendance-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .attendance-status.attended {
            background: #dbeafe;
            color: #1e40af;
        }

        .attendance-status.absent {
            background: #e5e7eb;
            color: #374151;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <img src="/logo.png" 
                     alt="1.FC K√∂ln Logo" class="club-logo">
                <div>
                    <h1 class="page-title">Schedule Management</h1>
                </div>
            </div>
            <div class="header-actions">
                <a href="/dashboard.html" class="back-btn" data-testid="button-back">‚Üê Back to Dashboard</a>
                <button class="create-btn" data-action="create-event" data-testid="button-create-event">+ Create Event</button>
            </div>
        </div>

        <!-- Message -->
        <div id="message" style="display: none;"></div>

        <!-- Calendar -->
        <div class="calendar-container">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="nav-btn" data-action="prev-month" data-testid="button-prev-month">‚Üê Previous</button>
                    <h2 class="current-month" id="currentMonth" data-testid="text-current-month"></h2>
                    <button class="nav-btn" data-action="next-month" data-testid="button-next-month">Next ‚Üí</button>
                </div>
            </div>

            <div id="eventsContainer" class="events-list">
                <div class="loading">Loading events...</div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Event Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Create Event</h2>
                <button class="close-btn" data-action="close-modal">&times;</button>
            </div>
            <form id="eventForm">
                <input type="hidden" id="eventId">
                
                <div class="form-group">
                    <label class="form-label" for="title">Event Title *</label>
                    <input type="text" id="title" class="form-input" required data-testid="input-event-title">
                </div>

                <div class="form-group">
                    <label class="form-label" for="eventType">Event Type *</label>
                    <select id="eventType" class="form-select" required data-testid="select-event-type">
                        <option value="">Select type...</option>
                        <option value="training">Training</option>
                        <option value="match">Match</option>
                        <option value="meeting">Meeting</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="date">Date *</label>
                    <input type="date" id="date" class="form-input" required data-testid="input-event-date">
                </div>

                <div class="form-group">
                    <label class="form-label" for="startTime">Start Time *</label>
                    <input type="time" id="startTime" class="form-input" required data-testid="input-event-start-time">
                </div>

                <div class="form-group">
                    <label class="form-label" for="endTime">End Time *</label>
                    <input type="time" id="endTime" class="form-input" required data-testid="input-event-end-time">
                </div>

                <div class="form-group">
                    <label class="form-label" for="location">Location</label>
                    <input type="text" id="location" class="form-input" data-testid="input-event-location">
                </div>

                <div class="form-group">
                    <label class="form-label" for="notes">Notes</label>
                    <textarea id="notes" class="form-textarea" data-testid="textarea-event-notes"></textarea>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="isRecurring" data-testid="checkbox-is-recurring">
                        <span>Recurring Event</span>
                    </label>
                </div>

                <div id="recurrenceOptions" style="display: none;">
                    <div class="form-group">
                        <label class="form-label" for="recurringPattern">Repeat Pattern *</label>
                        <select id="recurringPattern" class="form-select" data-testid="select-recurring-pattern">
                            <option value="">Select pattern...</option>
                            <option value="daily">Daily</option>
                            <option value="weekdays">Weekdays (Mon-Fri)</option>
                            <option value="sundays">Sundays Only</option>
                            <option value="custom">Custom Days</option>
                        </select>
                    </div>

                    <div id="customDaysOptions" style="display: none;">
                        <label class="form-label">Select Days</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" value="0" class="recurring-day" data-testid="checkbox-day-sunday">
                                <span>Sunday</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="1" class="recurring-day" data-testid="checkbox-day-monday">
                                <span>Monday</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="2" class="recurring-day" data-testid="checkbox-day-tuesday">
                                <span>Tuesday</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="3" class="recurring-day" data-testid="checkbox-day-wednesday">
                                <span>Wednesday</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="4" class="recurring-day" data-testid="checkbox-day-thursday">
                                <span>Thursday</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="5" class="recurring-day" data-testid="checkbox-day-friday">
                                <span>Friday</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="6" class="recurring-day" data-testid="checkbox-day-saturday">
                                <span>Saturday</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="recurringEndDate">End Date *</label>
                        <input type="date" id="recurringEndDate" class="form-input" data-testid="input-recurring-end-date">
                        <small class="form-hint">Last date for this recurring event</small>
                    </div>
                </div>

                <button type="submit" class="submit-btn" data-testid="button-submit-event">Save Event</button>
            </form>
        </div>
    </div>

    <!-- Attendance Modal -->
    <div id="attendanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Event Attendance</h2>
                <button class="close-btn" data-action="close-attendance-modal">&times;</button>
            </div>
            <div id="attendanceContainer" class="attendance-list">
                <div class="loading">Loading attendance...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/fckoln';
        const API_KEY = 'fckoln_b3aae37289943ee96b595915fe9e425a643fa794cfd7ad81b8ed777a6928a505';
        
        let currentDate = new Date();
        let allEvents = [];
        let currentEventId = null;

        // Auth token
        const token = sessionStorage.getItem('fckoln_token');
        if (!token) {
            window.location.href = '/';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateMonthDisplay();
            loadEvents();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Create event button
            document.querySelector('[data-action="create-event"]').addEventListener('click', () => {
                openEventModal();
            });

            // Close modals
            document.querySelector('[data-action="close-modal"]').addEventListener('click', closeEventModal);
            document.querySelector('[data-action="close-attendance-modal"]').addEventListener('click', closeAttendanceModal);

            // Click outside modal to close
            document.getElementById('eventModal').addEventListener('click', (e) => {
                if (e.target.id === 'eventModal') closeEventModal();
            });
            document.getElementById('attendanceModal').addEventListener('click', (e) => {
                if (e.target.id === 'attendanceModal') closeAttendanceModal();
            });

            // Month navigation
            document.querySelector('[data-action="prev-month"]').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateMonthDisplay();
                loadEvents();
            });

            document.querySelector('[data-action="next-month"]').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateMonthDisplay();
                loadEvents();
            });

            // Event form
            document.getElementById('eventForm').addEventListener('submit', handleEventSubmit);

            // Recurring event toggle
            document.getElementById('isRecurring').addEventListener('change', (e) => {
                const recurrenceOptions = document.getElementById('recurrenceOptions');
                if (e.target.checked) {
                    recurrenceOptions.style.display = 'block';
                } else {
                    recurrenceOptions.style.display = 'none';
                }
            });

            // Recurring pattern change
            document.getElementById('recurringPattern').addEventListener('change', (e) => {
                const customDaysOptions = document.getElementById('customDaysOptions');
                if (e.target.value === 'custom') {
                    customDaysOptions.style.display = 'block';
                } else {
                    customDaysOptions.style.display = 'none';
                }
            });
        }

        function updateMonthDisplay() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonth').textContent = 
                `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        }

        async function loadEvents() {
            try {
                const startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1)
                    .toISOString().split('T')[0];
                const endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0)
                    .toISOString().split('T')[0];

                const response = await fetch(
                    `${API_BASE}/events?startDate=${startDate}&endDate=${endDate}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'X-App-Key': API_KEY
                        }
                    }
                );

                const data = await response.json();
                
                if (data.success) {
                    allEvents = data.events;
                    renderEvents();
                } else {
                    showMessage('Failed to load events', 'error');
                }
            } catch (error) {
                console.error('Error loading events:', error);
                showMessage('Failed to load events', 'error');
            }
        }

        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            
            if (allEvents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No events scheduled for this period</p>
                    </div>
                `;
                return;
            }

            // Sort by date and time
            allEvents.sort((a, b) => {
                const dateCompare = a.date.localeCompare(b.date);
                if (dateCompare !== 0) return dateCompare;
                return a.start_time.localeCompare(b.start_time);
            });

            container.innerHTML = allEvents.map(event => {
                const eventDate = new Date(event.date + 'T00:00:00');
                const formattedDate = eventDate.toLocaleDateString('en-GB', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

                return `
                    <div class="event-card ${event.event_type}" data-testid="card-event-${event.id}">
                        <div class="event-header">
                            <h3 class="event-title">${event.title}</h3>
                            <span class="event-type-badge ${event.event_type}">
                                ${event.event_type}
                            </span>
                        </div>
                        <div class="event-details">
                            <div class="event-detail">
                                <span>üìÖ</span>
                                <span>${formattedDate}</span>
                            </div>
                            <div class="event-detail">
                                <span>‚è∞</span>
                                <span>${event.start_time} - ${event.end_time}</span>
                            </div>
                            ${event.location ? `
                                <div class="event-detail">
                                    <span>üìç</span>
                                    <span>${event.location}</span>
                                </div>
                            ` : ''}
                            ${event.notes ? `
                                <div class="event-detail">
                                    <span>üìù</span>
                                    <span>${event.notes}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="event-actions">
                            <button class="action-btn attendance" data-action="view-attendance" data-event-id="${event.id}" data-testid="button-view-attendance-${event.id}">
                                üìä View Attendance
                            </button>
                            <button class="action-btn edit" data-action="edit-event" data-event-id="${event.id}" data-testid="button-edit-event-${event.id}">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="action-btn delete" data-action="delete-event" data-event-id="${event.id}" data-testid="button-delete-event-${event.id}">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Add event listeners
            document.querySelectorAll('[data-action="edit-event"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const eventId = e.target.getAttribute('data-event-id');
                    const event = allEvents.find(ev => ev.id == eventId);
                    openEventModal(event);
                });
            });

            document.querySelectorAll('[data-action="delete-event"]').forEach(btn => {
                btn.addEventListener('click', handleDeleteEvent);
            });

            document.querySelectorAll('[data-action="view-attendance"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const eventId = e.target.getAttribute('data-event-id');
                    openAttendanceModal(eventId);
                });
            });
        }

        function openEventModal(event = null) {
            currentEventId = event ? event.id : null;
            document.getElementById('modalTitle').textContent = event ? 'Edit Event' : 'Create Event';
            
            if (event) {
                document.getElementById('eventId').value = event.id;
                document.getElementById('title').value = event.title;
                document.getElementById('eventType').value = event.event_type;
                document.getElementById('date').value = event.date;
                document.getElementById('startTime').value = event.start_time;
                document.getElementById('endTime').value = event.end_time;
                document.getElementById('location').value = event.location || '';
                document.getElementById('notes').value = event.notes || '';
            } else {
                document.getElementById('eventForm').reset();
                document.getElementById('eventId').value = '';
            }
            
            document.getElementById('eventModal').classList.add('active');
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('active');
            document.getElementById('eventForm').reset();
            document.getElementById('recurrenceOptions').style.display = 'none';
            document.getElementById('customDaysOptions').style.display = 'none';
            currentEventId = null;
        }

        async function handleEventSubmit(e) {
            e.preventDefault();

            const isRecurring = document.getElementById('isRecurring').checked;
            
            const formData = {
                title: document.getElementById('title').value,
                eventType: document.getElementById('eventType').value,
                date: document.getElementById('date').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                location: document.getElementById('location').value,
                notes: document.getElementById('notes').value,
                isRecurring: isRecurring
            };

            if (isRecurring) {
                const recurringPattern = document.getElementById('recurringPattern').value;
                
                if (!recurringPattern) {
                    showMessage('Please select a recurrence pattern', 'error');
                    return;
                }
                
                const recurringEndDate = document.getElementById('recurringEndDate').value;
                if (!recurringEndDate) {
                    showMessage('Please select an end date for the recurring event', 'error');
                    return;
                }

                formData.recurringPattern = recurringPattern;
                formData.recurringEndDate = recurringEndDate;

                if (recurringPattern === 'custom') {
                    const selectedDays = Array.from(document.querySelectorAll('.recurring-day:checked'))
                        .map(cb => cb.value);
                    
                    if (selectedDays.length === 0) {
                        showMessage('Please select at least one day for custom recurrence', 'error');
                        return;
                    }
                    
                    formData.recurringDays = selectedDays.join(',');
                }
            }

            const url = currentEventId 
                ? `${API_BASE}/events/${currentEventId}`
                : `${API_BASE}/events`;
            const method = currentEventId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'X-App-Key': API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(
                        currentEventId ? 'Event updated successfully!' : 'Event created successfully!',
                        'success'
                    );
                    closeEventModal();
                    loadEvents();
                } else {
                    showMessage(data.message || 'Failed to save event', 'error');
                }
            } catch (error) {
                console.error('Error saving event:', error);
                showMessage('Failed to save event', 'error');
            }
        }

        async function handleDeleteEvent(e) {
            const eventId = e.target.getAttribute('data-event-id');
            const event = allEvents.find(ev => ev.id == eventId);
            
            if (!confirm(`Are you sure you want to delete "${event.title}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/events/${eventId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'X-App-Key': API_KEY
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('Event deleted successfully!', 'success');
                    loadEvents();
                } else {
                    showMessage(data.message || 'Failed to delete event', 'error');
                }
            } catch (error) {
                console.error('Error deleting event:', error);
                showMessage('Failed to delete event', 'error');
            }
        }

        async function openAttendanceModal(eventId) {
            document.getElementById('attendanceModal').classList.add('active');
            
            try {
                const response = await fetch(`${API_BASE}/events/${eventId}/attendance`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'X-App-Key': API_KEY
                    }
                });

                const data = await response.json();

                if (data.success) {
                    renderAttendance(data.attendance);
                } else {
                    document.getElementById('attendanceContainer').innerHTML = 
                        '<p class="empty-state">Failed to load attendance</p>';
                }
            } catch (error) {
                console.error('Error loading attendance:', error);
                document.getElementById('attendanceContainer').innerHTML = 
                    '<p class="empty-state">Failed to load attendance</p>';
            }
        }

        function renderAttendance(attendance) {
            const container = document.getElementById('attendanceContainer');
            
            if (attendance.length === 0) {
                container.innerHTML = '<p class="empty-state">No attendance records yet</p>';
                return;
            }

            container.innerHTML = attendance.map(att => `
                <div class="attendance-item">
                    <span class="attendance-name">${att.first_name} ${att.last_name}</span>
                    <span class="attendance-status ${att.status}">${att.status.replace('_', ' ')}</span>
                </div>
            `).join('');
        }

        function closeAttendanceModal() {
            document.getElementById('attendanceModal').classList.remove('active');
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
